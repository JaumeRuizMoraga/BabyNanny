package babbynannyapi.controller;

import org.bson.json.JsonObject;
import org.json.JSONException;
import org.json.JSONObject;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import babbynannyapi.model.Bebe;
import babbynannyapi.model.Token;
import babbynannyapi.model.Usuario;
import babbynannyapi.repository.BebeRepository;
import babbynannyapi.repository.TokenRepository;
import babbynannyapi.repository.UsuarioRepository;

import java.io.*;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Optional;


@RestController
@RequestMapping("/BabyNanny")
public class Controlador {

	@Autowired
	private UsuarioRepository usuarioRepository;
	
	@Autowired
	private TokenRepository tokenRepository;
	
	@Autowired
	private BebeRepository bebeRepository;

	/**
	 * Función utilitzada para que un usuario haga login y se le genere un token
	 * @param usuario
	 * @return ResponseEntity<?>
	 */
	@PostMapping("/login")

	public ResponseEntity<Object> login(@RequestBody Usuario usuario) throws JSONException {

		System.out.println(usuario.getNombre());
		System.out.println(usuario.getPassword());
		Optional<Usuario> user = usuarioRepository.findByNombreAndPassword(usuario.getNombre(), usuario.getPassword());
		if (user.isPresent()) {
			Token token = new Token(usuario.getNombre());
			tokenRepository.save(token);
			return ResponseEntity.status(HttpStatus.NO_CONTENT).build();
		}
		return ResponseEntity.status(HttpStatus.UNAUTHORIZED).build();
	}
	
	/**
	 * Función utilitzada pera registrar un usuario en la base de datos
	 * @param usuario
	 * @return ResponseEntity<?>
	 */
	@PostMapping("/register")
	ResponseEntity<?> registro(@RequestBody Usuario usuario){
		boolean existe = usuarioRepository.buscarUsuario(usuario.getNombre(), usuario.getPassword()
				,usuario.getCorreo());
		if (existe) {
			Token token = new Token(usuario.getNombre());
			tokenRepository.save(token);
			return ResponseEntity.status(HttpStatus.NO_CONTENT).build();
		}
		return ResponseEntity.status(HttpStatus.UNAUTHORIZED).build();
	}
	
	/**
	 * Función utilitzada para guardar un bebe en la base de datos
	 * @param bebe
	 * @return ResponseEntity<?>
	 */
	@PostMapping("/newBaby")
	ResponseEntity<Object> registro(@RequestBody Bebe bebe, @RequestHeader String token ){
		Optional<Token> t = tokenRepository.buscarToken(token);
		if (t.isPresent()) {
			bebeRepository.save(bebe);
			return ResponseEntity.status(HttpStatus.NO_CONTENT).build();
		}
		return ResponseEntity.status(HttpStatus.UNAUTHORIZED).build();
	}
	
	@PostMapping("/babys")
	ResponseEntity<Object> buscarBebes(@RequestParam(name = "token") String token){
		Optional<Token> t = tokenRepository.buscarToken(token);
		if (t.isPresent()) {
			List<Bebe> listaBebes = bebeRepository.findAll(null);
		    Map<String, List<Bebe>> response = new HashMap<>();
		    response.put("bebes", listaBebes);
			return ResponseEntity.status(HttpStatus.NO_CONTENT).build();
		}
		return ResponseEntity.status(HttpStatus.UNAUTHORIZED).build();
	}
}