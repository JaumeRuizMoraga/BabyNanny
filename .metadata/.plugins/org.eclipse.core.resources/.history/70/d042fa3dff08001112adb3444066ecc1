package babbynannyapi.controller;

import org.bson.json.JsonObject;
import org.json.JSONException;
import org.json.JSONObject;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import babbynannyapi.model.Bebe;
import babbynannyapi.model.Token;
import babbynannyapi.model.Usuario;
import babbynannyapi.repository.BabyRepository;
import babbynannyapi.repository.TokenRepository;
import babbynannyapi.repository.UserRepository;

import java.io.*;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Optional;


@RestController
@RequestMapping("/BabyNanny")
public class Controlador {

	@Autowired
	private UserRepository userRepository;

	@Autowired
	private TokenRepository tokenRepository;

	@Autowired
	private BabyRepository babyRepository;


	@GetMapping("/babys")
	ResponseEntity<Object> buscarBebes(@RequestParam(name = "token") String token){
		Optional<Token> t = tokenRepository.searchToken(token);
		if (t.isPresent()) {
			List<Bebe> babyList = babyRepository.searchBabies(t.get().getUser());
		    Map<String, List<Bebe>> response = new HashMap<>();
		    response.put("bebes", babyList);
			return ResponseEntity.status(HttpStatus.OK).body(response);
		}
		return ResponseEntity.status(HttpStatus.UNAUTHORIZED).build();
	}

	@PutMapping("/newEntry")
	ResponseEntity<Object> newEntry(@RequestParam(name = "id") String token){
		Optional<Token> t = tokenRepository.searchToken(token);
		if (t.isPresent()) {
			List<Bebe> listaBebes = babyRepository.searchBabies(t.get().getUser());
		    Map<String, List<Bebe>> response = new HashMap<>();
		    response.put("bebes", listaBebes);
		    response.put("bebes2", listaBebes);
			return ResponseEntity.status(HttpStatus.NO_CONTENT).build();
		}
		return ResponseEntity.status(HttpStatus.UNAUTHORIZED).build();
	}
    /**
     * Función utilitzada para que un usuario haga login y se le genere un token
     *
     * @param usuario
     * @return ResponseEntity<?>
     */
    @PostMapping("/login")

    public ResponseEntity<Object> login(@RequestBody Usuario usuario) throws JSONException {
        Optional<Usuario> user = userRepository.findByNombreAndPassword(usuario.getNombre(), usuario.getPassword());
        Optional<Token> usertoken = tokenRepository.searchUserToken(usuario.getNombre());
        if (user.isPresent()) {
            if (usertoken.isPresent()) {
                return ResponseEntity.status(HttpStatus.CONFLICT).build();
            } else {
                Token token = new Token(usuario.getNombre());
                tokenRepository.save(token);
                return ResponseEntity.status(HttpStatus.NO_CONTENT).build();
            }
        } else {
            return ResponseEntity.status(HttpStatus.UNAUTHORIZED).build();
        }
    }

    /**
     * Función utilitzada pera registrar un usuario en la base de datos
     *
     * @param user
     * @return ResponseEntity<?>
     */
    @PostMapping("/register")
    ResponseEntity<?> registro(@RequestBody Usuario user) {
        Optional<Usuario> userPassEmail = userRepository.searchUserPassEmail(user.getNombre(), user.getPassword(), user.getCorreo());
        if (userPassEmail.isPresent()) {
            return ResponseEntity.status(HttpStatus.CONFLICT).build();
        }
        else {
        	userRepository.save(user);
            return ResponseEntity.status(HttpStatus.OK).build();
        }

    }
}